<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANPR Guardian | Premium</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
        }

        .font-mono-tech {
            font-family: 'Orbitron', monospace;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .live-indicator {
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }
    </style>
</head>

<body class="text-slate-200 h-screen overflow-hidden flex flex-col">

    <!-- Header -->
    <header class="glass-panel z-50 h-16 flex items-center justify-between px-6 border-b border-indigo-500/20">
        <div class="flex items-center space-x-3">
            <div
                class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center shadow-lg shadow-indigo-500/30">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>
            </div>
            <h1 class="text-xl font-bold tracking-tight text-white"><span class="text-indigo-400">ANPR</span> GUARDIAN
            </h1>
        </div>
        <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2 px-3 py-1 rounded-full bg-slate-800/50 border border-slate-700">
                <div class="w-2 h-2 rounded-full bg-green-500 live-indicator"></div>
                <span class="text-xs font-semibold text-green-400 uppercase tracking-wider">System Active</span>
            </div>
            <span id="clock" class="text-sm font-mono text-slate-400">00:00:00</span>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative overflow-hidden">

        <!-- Video Feed Area -->
        <div class="flex-1 relative bg-black flex items-center justify-center group overflow-hidden">
            <img src="/video_feed" class="w-full h-full object-contain" alt="Live Feed">

            <!-- Top Left: Controls & Status -->
            <div class="absolute top-4 left-4 flex flex-col space-y-2 z-50">
                <div class="flex space-x-2">
                    <span
                        class="px-3 py-1 bg-black/60 backdrop-blur text-xs font-mono text-red-500 border border-red-500/30 rounded-full flex items-center shadow-lg">
                        <span class="w-2 h-2 bg-red-500 rounded-full mr-2 animate-pulse"></span> LIVE
                    </span>
                    <!-- Source Switcher -->
                    <select id="cam-source"
                        class="px-3 py-1 bg-black/60 backdrop-blur text-xs font-mono text-indigo-400 border border-indigo-500/30 rounded-full focus:outline-none cursor-pointer shadow-lg appearance-none text-center">
                        <option value="server">Server Cam</option>
                        <option value="local">Mobile Cam</option>
                    </select>
                </div>
            </div>

            <!-- Server Feed (Image) -->
            <img id="server-feed" src="/video_feed" class="absolute inset-0 w-full h-full object-contain"
                alt="Live Feed">

            <!-- Local Camera Feed (Video & Canvas) -->
            <div id="local-feed-container"
                class="hidden absolute inset-0 w-full h-full flex items-center justify-center bg-black">
                <video id="local-video" autoplay playsinline muted class="w-full h-full object-contain"></video>
                <canvas id="local-canvas" class="absolute inset-0 w-full h-full pointer-events-none"></canvas>
            </div>

            <!-- Rec Indicator -->
            <div id="rec-indicator"
                class="hidden absolute top-4 right-4 flex items-center space-x-2 bg-red-600/90 text-white px-3 py-1 rounded-full shadow-lg animate-pulse z-50">
                <div class="w-2 h-2 bg-white rounded-full"></div>
                <span class="text-xs font-bold tracking-widest">REC</span>
            </div>
        </div>

        <!-- Minimal Info Panel (Bottom Overlay Style) -->
        <div
            class="glass-panel border-t border-indigo-500/20 px-6 py-4 flex flex-col md:flex-row items-center justify-between gap-4 z-50 relative bg-slate-900/90 backdrop-blur-xl">

            <!-- Left: Detection Info -->
            <div class="flex-1 w-full md:w-auto flex items-center space-x-6">
                <!-- Plate Display -->
                <div class="relative group">
                    <div
                        class="absolute -inset-1 bg-gradient-to-r from-yellow-600 to-amber-600 rounded-lg blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200">
                    </div>
                    <div
                        class="relative px-6 py-3 bg-slate-900 ring-1 ring-slate-900/5 rounded-lg leading-none flex items-center space-x-4 border border-yellow-500/30">
                        <span class="text-xs text-yellow-500/70 font-bold tracking-wider uppercase">PLATE</span>
                        <span id="current-plate"
                            class="text-3xl md:text-4xl font-mono-tech font-bold text-yellow-400 tracking-widest drop-shadow-[0_0_10px_rgba(250,204,21,0.5)]">Scanning..</span>
                    </div>
                </div>

                <!-- Vehicle Type -->
                <div class="hidden md:block border-l border-slate-700 pl-6">
                    <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-0.5">Vehicle Type</p>
                    <p id="current-type" class="text-lg font-mono text-indigo-300">---</p>
                </div>
            </div>

            <!-- Right: Controls -->
            <div class="w-full md:w-auto flex items-center space-x-4">
                <!-- Mobile Vehicle Type (Visible only on small screens) -->
                <div class="md:hidden flex-1">
                    <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Vehicle</p>
                    <p id="current-type-mobile" class="text-lg font-mono text-indigo-300">---</p>
                </div>

                <button id="btn-record"
                    class="flex-1 md:flex-none py-3 px-8 rounded-xl font-bold text-sm tracking-widest uppercase transition-all duration-300 bg-slate-800 hover:bg-slate-700 text-white shadow-lg flex items-center justify-center space-x-2 border border-slate-700 group">
                    <div
                        class="w-3 h-3 bg-red-500 rounded-full group-hover:shadow-[0_0_10px_rgba(239,68,68,0.8)] transition-shadow">
                    </div>
                    <span>Record</span>
                </button>
            </div>
        </div>
    </main>

    <script>
        // Update Clock
        setInterval(() => {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString();
        }, 1000);

        // State & Elements
        let isRecording = false;
        const currentType = document.getElementById('current-type');
        const currentTypeMobile = document.getElementById('current-type-mobile');
        const currentPlate = document.getElementById('current-plate');
        const btnRecord = document.getElementById('btn-record');
        const recIndicator = document.getElementById('rec-indicator');

        // Stats Polling (Simplified)
        async function fetchStats() {
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();

                // Update Detection Info
                if (data.latest_vehicle !== "None") {
                    currentType.innerText = data.latest_vehicle;
                    if (currentTypeMobile) currentTypeMobile.innerText = data.latest_vehicle;
                }

                if (data.latest_plate !== "None") {
                    currentPlate.innerText = data.latest_plate;
                    // Add flash effect logic here if desired
                }

                // Update Recording State
                if (data.recording !== isRecording) {
                    isRecording = data.recording;
                    updateRecordUI();
                }

            } catch (err) {
                console.error("Stats Error:", err);
            }
        }

        function updateRecordUI() {
            if (isRecording) {
                btnRecord.innerHTML = '<div class="w-3 h-3 bg-slate-300 rounded-sm"></div><span>Stop</span>';
                btnRecord.classList.add('bg-red-600/20', 'border-red-500', 'text-red-400');
                btnRecord.classList.remove('bg-slate-800', 'border-slate-700', 'text-white');
                recIndicator.classList.remove('hidden');
            } else {
                btnRecord.innerHTML = '<div class="w-3 h-3 bg-red-500 rounded-full"></div><span>Record</span>';
                btnRecord.classList.remove('bg-red-600/20', 'border-red-500', 'text-red-400');
                btnRecord.classList.add('bg-slate-800', 'border-slate-700', 'text-white');
                recIndicator.classList.add('hidden');
            }
        }

        btnRecord.addEventListener('click', async () => {
            await fetch('/api/record', { method: 'POST' });
            fetchStats();
        });

        // Poll every 500ms for faster updates
        setInterval(fetchStats, 500);
        fetchStats();

        // ============================
        // MOBILE CAMERA LOGIC (Kept Same)
        // ============================
        const camSource = document.getElementById('cam-source');
        const serverFeed = document.getElementById('server-feed');
        const localFeedContainer = document.getElementById('local-feed-container');
        const localVideo = document.getElementById('local-video');
        const localCanvas = document.getElementById('local-canvas');
        const ctx = localCanvas.getContext('2d');

        let localStream = null;
        let processInterval = null;

        camSource.addEventListener('change', async (e) => {
            if (e.target.value === 'local') {
                startLocalCamera();
            } else {
                stopLocalCamera();
            }
        });

        async function startLocalCamera() {
            // UI Toggle
            serverFeed.classList.add('hidden');
            localFeedContainer.classList.remove('hidden');

            try {
                // Request Camera (Rear prefered)
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                localVideo.srcObject = localStream;

                // Start Processing Loop
                processInterval = setInterval(processLocalFrame, 500); // 2 FPS

                // Adjust Canvas Size
                localVideo.onloadedmetadata = () => {
                    localCanvas.width = localVideo.videoWidth;
                    localCanvas.height = localVideo.videoHeight;
                };

            } catch (err) {
                alert("Camera Access Denied or Error: " + err);
                camSource.value = 'server'; // Revert
                stopLocalCamera();
            }
        }

        function stopLocalCamera() {
            // UI Toggle
            serverFeed.classList.remove('hidden');
            localFeedContainer.classList.add('hidden');

            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (processInterval) {
                clearInterval(processInterval);
                processInterval = null;
            }
        }

        async function processLocalFrame() {
            if (!localVideo.videoWidth) return;

            // 1. Capture Frame to Blob (Resize to 640w for speed)
            const offCanvas = document.createElement('canvas');
            const scale = 640 / localVideo.videoWidth;
            offCanvas.width = 640;
            offCanvas.height = localVideo.videoHeight * scale;

            const offCtx = offCanvas.getContext('2d');
            offCtx.drawImage(localVideo, 0, 0, offCanvas.width, offCanvas.height);

            offCanvas.toBlob(sendFrameToServer, 'image/jpeg', 0.7);
        }

        function sendFrameToServer(blob) {
            const formData = new FormData();
            formData.append('frame', blob);

            fetch('/api/detect_frame', {
                method: 'POST',
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    drawResults(data.results);
                })
                .catch(err => console.log("Processing Error", err));
        }

        function drawResults(results) {
            // Clear Canvas
            localCanvas.width = localVideo.videoWidth; // Ensure sync
            localCanvas.height = localVideo.videoHeight;
            ctx.clearRect(0, 0, localCanvas.width, localCanvas.height);

            if (!results) return;

            // Calculate Scale Back 
            const scale = localVideo.videoWidth / 640;

            results.forEach(item => {
                const color = `rgb(${item.color[2]}, ${item.color[1]}, ${item.color[0]})`; // BGR to RGB
                ctx.strokeStyle = color;
                ctx.lineWidth = 4;
                ctx.fillStyle = color;
                ctx.font = "bold 24px monospace";

                // Coords
                let [x1, y1, x2, y2] = item.coords;
                // Scale coords if item has them (checking type for safety)
                if (item.coords.length === 4) {
                    ctx.strokeRect(x1 * scale, y1 * scale, (x2 - x1) * scale, (y2 - y1) * scale);
                    if (item.label) {
                        ctx.fillText(item.label, x1 * scale, (y1 * scale) - 10);
                    }
                } else if (item.coords.length === 2) {
                    // Text point
                    ctx.fillText(item.label, item.coords[0] * scale, item.coords[1] * scale);
                }
            });
        }
    </script>
</body>

</html>